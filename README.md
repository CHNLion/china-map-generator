# 中国地图生成器

中国地图生成器是一个基于Flask和GeoPandas的Web应用程序，用于从Shapefile文件生成高质量的中国行政区划地图。该应用程序提供了直观的用户界面，支持多级行政区划地图生成，并具有强大的多区域突出显示功能和完善的自定义选项。

## ✨ 核心特性

### 🗺️ 多级行政区划地图
- **全国地图**：显示全国省级行政区划
- **省级地图**：显示指定省份的市级行政区划
- **市级地图**：显示指定城市的县区级行政区划
- **县级地图**：显示指定县区的详细行政区划

### 🎯 智能多区域突出显示
- **多区域支持**：可以同时突出显示多个区域（省、市、县）
- **独立颜色设置**：每个突出显示区域可以设置不同的颜色
- **智能区域锁定**：
  - 突出显示区域自动跟随底图区域
  - 根据底图选择情况智能锁定省份/城市
  - 只显示与底图类型相关的选择框
- **动态同步**：底图区域改变时，突出显示区域自动更新

### 🎨 高级颜色选择器
- **Pickr颜色选择器**：支持RGB、HSL、HEX多种模式
- **实时预览**：颜色更改即时预览
- **预设颜色板**：16种常用颜色快速选择
- **可视化边框**：颜色块带有边框，即使白色也清晰可见

### 🛠️ 丰富的自定义选项
- **底图颜色**：自定义地图底色
- **边界线样式**：自定义边界线颜色和宽度（0.1-3.0）
- **地名标签**：可选择是否显示地区名称
- **经纬度坐标**：可选择显示经纬度网格，支持字体大小调整（10-30）
- **地图标题**：可自定义标题内容和字体大小

### 📐 精确的地图投影
- **Lambert正形圆锥投影**：使用中国测绘标准投影（lat_1=25°, lat_2=47°）
- **正确的宽高比**：地图比例准确，不会变形
- **中心经度优化**：中心经度设置为105°，适合中国地图

### 💾 便捷的导出功能
- **高分辨率PNG**：DPI 300，适合打印
- **Base64编码传输**：无需服务器存储，直接在浏览器中预览和下载
- **智能文件命名**：根据区域和时间戳自动命名

## 🎯 使用场景

- ✅ 教育教学：制作地理课件
- ✅ 数据可视化：展示区域数据分布
- ✅ 报告演示：生成专业的区域地图
- ✅ 研究分析：标注多个研究区域
- ✅ 政策展示：突出显示政策覆盖区域

## 📋 详细功能说明

### 行政分界说明

行政分界决定了地图上显示的行政边界级别：

| 行政分界 | 说明 |
|---------|------|
| **全国** | 显示所有省级行政区边界 |
| **省** | 显示省内所有市级行政区边界 |
| **市** | 显示市内所有县区级行政区边界 |
| **县** | 显示县区内详细行政边界 |

### 底图区域说明

底图区域决定了地图的显示范围。系统根据用户的最后一级选择来确定地图范围：

1. 选择了县级区域 → 显示该县的地图
2. 只选择了市级区域 → 显示该市的地图
3. 只选择了省级区域 → 显示该省的地图
4. 没有选择任何区域 → 显示全国地图

### 突出显示功能

**智能显示逻辑**：
- **底图 = 全国**：突出显示只显示"省份"选择框
- **底图 = 省**：突出显示只显示"省份"选择框
- **底图 = 市**：突出显示显示"省份"和"城市"选择框
- **底图 = 县**：突出显示显示"省份"、"城市"和"县区"选择框

**智能锁定逻辑**：
- 底图选择了省份 → 突出显示的省份自动锁定
- 底图选择了城市 → 突出显示的省份和城市自动锁定
- 底图未做选择 → 突出显示区域可以自由选择

**多区域突出显示**：
- 点击"+ 添加区域"可以添加多个突出显示区域
- 每个区域可以设置不同的颜色
- 至少保留一个区域，删除按钮会自动管理显示

### 颜色选择器功能

使用Pickr颜色选择器，提供以下功能：
- **色相环**：直观的颜色选择
- **RGB模式**：红绿蓝分量调整
- **HSL模式**：色相、饱和度、亮度调整
- **HEX输入**：直接输入十六进制颜色值
- **预设颜色**：16种常用颜色快速选择
- **实时预览**：选择时即时预览效果

### 经纬度坐标功能

- 默认禁用，启用后显示经纬度网格
- 坐标格式：度数°E/N（如"120.45°E"）
- 网格线为虚线样式，便于读取
- 字体大小可调（10-30，默认20）

### 地图标题功能

- 默认禁用，启用后可添加标题
- 自动生成默认标题：
  - 优先使用突出显示区域（如果已启用）
  - 否则使用底图区域
  - 格式："XX行政区划图"
- 支持自定义标题文本和字体大小

## 💻 技术栈

### 后端
- **Python 3.9+**
- **Flask** - 轻量级Web框架
- **GeoPandas** - 地理数据处理
- **Matplotlib** - 地图绘制
- **Shapely** - 几何对象操作
- **Pyproj** - 坐标系转换

### 前端
- **HTML5 / CSS3** - 页面结构和样式
- **JavaScript (ES6+)** - 交互逻辑
- **Bootstrap 5** - UI框架
- **Pickr** - 高级颜色选择器

## 🚀 安装指南

### 前提条件

- Python 3.9 或更高版本
- pip 包管理器
- Git（可选，用于克隆仓库）

### 安装步骤

1. **克隆仓库**

```bash
git clone https://github.com/CHNLion/china-map-generator.git
cd china-map-generator
```

2. **创建虚拟环境（推荐）**

```bash
# Windows
python -m venv myenv
myenv\Scripts\activate

# Linux/macOS
python -m venv myenv
source myenv/bin/activate
```

3. **安装依赖项**

```bash
pip install -r requirements.txt
```

4. **准备Shapefile文件**

确保Shapefile文件放置在正确的位置：

```
china-map-generator/
└── shp/
    ├── 省.shp
    ├── 省.dbf
    ├── 省.shx
    ├── 市.shp
    ├── 市.dbf
    ├── 市.shx
    ├── 县.shp
    ├── 县.dbf
    └── 县.shx
```

## 📖 使用方法

### 启动应用

```bash
python app.py
```

应用将在 `http://127.0.0.1:5000/` 启动

### 基本使用流程

1. **选择行政分界**
   - 选择地图类型：全国、省、市或县

2. **选择底图区域**
   - 根据需要选择省份、城市、县区

3. **启用突出显示（可选）**
   - 勾选"启用突出显示"
   - 选择要突出显示的区域
   - 为每个区域选择颜色
   - 点击"+ 添加区域"添加更多突出显示区域

4. **自定义样式**
   - 调整底图颜色、边界线颜色和宽度
   - 选择是否显示地名标签
   - 选择是否显示经纬度坐标
   - 选择是否显示地图标题

5. **生成地图**
   - 点击"生成地图"按钮

6. **下载地图**
   - 点击"下载地图图片"保存PNG文件

## 💡 使用示例

### 示例1：生成全国地图并突出显示多个省份

```
1. 选择行政分界：全国
2. 勾选"启用突出显示"
3. 选择省份：内蒙古自治区，颜色：红色
4. 点击"+ 添加区域"
5. 选择省份：新疆维吾尔自治区，颜色：蓝色
6. 点击"生成地图"
```

### 示例2：生成省级地图并突出显示多个城市

```
1. 选择行政分界：省
2. 选择底图省份：内蒙古自治区
3. 勾选"启用突出显示"
4. 突出显示自动锁定为：内蒙古自治区
5. 选择城市：呼和浩特市，颜色：橙色
6. 点击"+ 添加区域"
7. 选择城市：包头市，颜色：绿色
8. 点击"生成地图"
```

### 示例3：生成带标题和经纬度的地图

```
1. 选择行政分界：市
2. 选择省份：内蒙古自治区
3. 选择城市：呼和浩特市
4. 勾选"显示经纬度坐标"
5. 勾选"显示图片名称"
6. 自定义标题：呼和浩特市行政区划图
7. 点击"生成地图"
```

## 📁 项目结构

```
china-map-generator/
├── app/
│   ├── controllers/
│   │   └── map_controller.py      # 地图生成核心逻辑
│   ├── static/
│   │   ├── css/
│   │   │   └── style.css          # 自定义样式
│   │   ├── js/
│   │   │   ├── main.js            # 主交互逻辑
│   │   │   ├── multi-highlight.js # 多区域突出显示逻辑
│   │   │   └── color-picker.js    # 颜色选择器初始化
│   │   └── maps/                  # 本地保存地图目录（可选）
│   └── templates/
│       └── index.html             # 主页面模板
├── shp/                           # Shapefile数据目录
│   ├── 省.shp
│   ├── 市.shp
│   ├── 县.shp
│   └── ...
├── app.py                         # Flask应用入口
├── requirements.txt               # Python依赖
└── README.md                      # 项目文档
```

## ⚙️ 配置说明

### 默认设置

- **DPI设置**：图形DPI=100，保存DPI=300
- **图形尺寸**：16:9（16×9英寸）
- **底图颜色**：#EAEAEA（浅灰色）
- **边界线颜色**：#FFFFFF（白色）
- **边界线宽度**：1.5
- **突出显示颜色**：预设8种颜色循环使用
- **投影参数**：Lambert正形圆锥投影（lat_1=25°, lat_2=47°, lon_0=105°）

### 自定义配置

可以在 `app/controllers/map_controller.py` 中修改：
- 地图尺寸：修改 `figsize` 参数
- DPI设置：修改 `plt.rcParams['figure.dpi']` 和 `plt.rcParams['savefig.dpi']`
- 投影参数：修改 `asia_lcc_crs` 定义

## ⚠️ 注意事项

### 系统要求
- Python 3.9+ 必需
- 推荐使用虚拟环境
- Windows系统可能需要先安装GDAL和Fiona

### Shapefile要求
- 编码格式：UTF-8或GBK
- 必需文件：.shp、.dbf、.shx
- 字段要求：
  - 省级：需要包含省份名称字段
  - 市级：需要包含省份和城市名称字段
  - 县级：需要包含省份、城市和县区名称字段

### 性能提示
- 县级地图数据量较大，生成可能需要更长时间
- 显示经纬度会增加渲染时间
- 多区域突出显示会略微增加处理时间

### 浏览器兼容性
- Chrome 90+ ✅
- Firefox 88+ ✅
- Edge 90+ ✅
- Safari 14+ ✅

## 🐛 常见问题

**Q: 地图显示比例不正确，看起来被压扁了？**  
A: 确保使用了Lambert正形圆锥投影，并设置了 `ax.set_aspect('equal')`

**Q: 突出显示区域不在底图范围内？**  
A: 系统已实现智能锁定，突出显示区域会自动限制在底图范围内

**Q: 颜色选择器没有边框，白色时看不见？**  
A: 已添加边框样式，如果问题仍存在，请清除浏览器缓存后刷新

**Q: 中文显示为方块或乱码？**  
A: 确保系统安装了微软雅黑字体，或在代码中指定其他中文字体

**Q: 如何添加更多预设颜色？**  
A: 修改 `app/static/js/multi-highlight.js` 中的 `defaultColors` 数组

## 🔄 更新日志

### v2.0.0 (2025-01-11)
- ✨ 新增多区域突出显示功能
- ✨ 每个区域支持独立颜色设置
- ✨ 集成Pickr高级颜色选择器
- 🎨 智能区域锁定和同步机制
- 🎨 动态显示/隐藏选择框
- 🐛 修复地图投影和比例问题
- 🐛 修复Windows GBK编码问题

### v1.0.0
- 🎉 初始版本发布
- 基础地图生成功能
- 单区域突出显示
- 自定义颜色和样式

## 📄 许可证

本项目采用 MIT 许可证。详情请参阅 [LICENSE](LICENSE) 文件。

## 👨‍💻 作者

**CHNLion**

- GitHub: [@CHNLion](https://github.com/CHNLion)

## 🤝 贡献

欢迎提交问题和拉取请求！

1. Fork 本仓库
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启拉取请求

## 🙏 致谢

- [GeoPandas](https://geopandas.org/) - 地理数据处理
- [Matplotlib](https://matplotlib.org/) - 数据可视化
- [Flask](https://flask.palletsprojects.com/) - Web框架
- [Bootstrap](https://getbootstrap.com/) - UI框架
- [Pickr](https://github.com/Simonwep/pickr) - 颜色选择器

---

⭐ 如果这个项目对你有帮助，欢迎给个星标！
